on:
  pull_request:
    paths:
      # Only run coverage report if the sources have changed
      - "src/**.rs"
      - "crates/**.rs"
  push:
    branches:
      - main
    paths:
      # Only run coverage report if the sources have changed
      - "src/**.rs"
      - "crates/**.rs"

name: Code Coverage
jobs:
  codecov:
    runs-on: ubuntu-latest
    container:
      image: rust:slim-bookworm
      options: --security-opt seccomp=unconfined --privileged
    env:
      SPFS_SUPPRESS_OVERLAYFS_PARAMS_WARNING: "1"
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0
      - name: Setup spfs repos
        run: |
          mkdir /spfs
          mkdir -p /tmp/spfs-repos/local
          mkdir -p /tmp/spfs-repos/origin
          cat >/etc/spfs.conf << EOF
          [storage]
          root = /tmp/spfs-repos/local

          [remote.origin]
          address = file:///tmp/spfs-repos/origin?create=true
          EOF
      - name: Install prerequisites
        run: |
          apt-get update
          apt-get install --yes build-essential libcap2-bin sudo cmake tcsh rsync protobuf-compiler fuse libfuse-dev curl unzip pkg-config libssl-dev git
          # spfs-fuse requires this option enabled
          echo user_allow_other >> /etc/fuse.conf
          FB_REL=https://github.com/google/flatbuffers/releases/
          curl --proto '=https' --tlsv1.2 -sSfL ${FB_REL}/download/v23.5.26/Linux.flatc.binary.g++-10.zip | funzip > /usr/bin/flatc
          chmod +x /usr/bin/flatc
      - uses: actions/checkout@v3
      - name: Install ast-grep
        run: cargo install --locked --force ast-grep
      - name: Install llvm-tools and grcov
        run: |
          # set up the profiling requirements
          rustup component add llvm-tools
          cargo install grcov
      - name: Configure cargo
        run: |
          mkdir -p .cargo
          cat << EOF > .cargo/config.toml
          [build]
          # Disable incremental compilation to lower disk usage, and sccache
          # can't cache incremental compiles.
          incremental = false

          [profile.dev]
          # Disable debug information to lower disk usage.
          debug = false
          EOF
      - name: Install spfs
        run: |
          make install-debug-spfs FEATURES=server,spfs/server
          cargo clean
      - name: Generate code coverage
        run: |
          # Originally used tarpaulin but it used too much space to generate
          make coverage FEATURES=server,spfs/server,spfs/protobuf-src,spk/migration-to-components,sentry,statsd,fuse-backend,spfs-vfs/protobuf-src
      - name: Upload to codecov.io
        uses: codecov/codecov-action@v3
      - name: Code coverage summary report in logs
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          output: both
          format: markdown
          filename: target/debug/coverage/cobertura.xml
