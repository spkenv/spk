pkg: gcc/9.3.0

sources:
  - git: https://github.com/gcc-mirror/gcc
    ref: releases/gcc-9.3.0
  - path: activate-gcc.csh
  - path: activate-gcc.sh

build:
  options:
    - var: arch
    - var: os
    - var: distro
    - var: centos
    - pkg: stdfs
    - pkg: gmp
      default: 6.2
    - pkg: mpfr
      default: 4.1
    - pkg: mpc
      default: 1.0
    - pkg: autoconf
    - pkg: autogen
    - pkg: make
  script:
    - rm -rf build; mkdir build
    - cd build
    # sometimes autogen is not installed and causes a failure right at the end - which is annoying
    # so we do a quick check for it before getting started
    - which autogen
    - ../configure
      --prefix=/spfs
      --with-local-prefix=/spfs
      --with-mpfr=/spfs
      --with-gmp=/spfs
      --with-mpc=/spfs
      --disable-multilib
    # library path cannot be set when building gcc - it will due to a specific check for this
    - unset LIBRARY_PATH
    - make -j$(nproc)
    # - make check
    - make install
    # no need to keep extra bloat files in info dir
    - rm -r /spfs/share/info
    # include activation scripts
    - mkdir -p /spfs/etc/spfs/startup.d
    - cp activate-gcc.{csh,sh} /spfs/etc/spfs/startup.d/

tests:
  - stage: install
    script:
      - echo "int main() { return 1; }" > test.c
      - /spfs/bin/gcc test.c -o test.o
      - rm test.c test.o

install:
  requirements:
    - pkg: stdfs
    - pkg: mpfr
      fromBuildEnv: x.x
