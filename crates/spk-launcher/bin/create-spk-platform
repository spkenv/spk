#! /bin/bash

# Create an spfs platform for running spk via spk-launcher.
#
# This must be run from the top level of this project.

set -o errexit

[[ $# -lt 1 || $# -gt 2 ]] && echo "Usage: `basename $0` <spk version> [<tag name>]" && exit 1

spk_version="$1"
tag_name="${2:-$spk_version}"

# 1. build logic from spk.spec
mkdir -p build

# These commands are needed for building internal to SPI. To use this outside
# of SPI, refer to the build commands found in spk.spec at the root of the
# project.

export SPDEV_CONFIG_FILE=.site/spi/.spdev.yaml
dev toolchain install Rust
source ~/.bashrc
export SENTRY_DSN=http://4506b47108ac4b648fdf18a8d803f403@sentry.spimageworks.com/25
export SENTRY_ENVIRONMENT=production
export SENTRY_USERNAME_OVERRIDE_VAR=GITLAB_USER_LOGIN
export SPK_METRICS_STATSD_HOST=statsd.k8s.spimageworks.com
export SPK_METRICS_STATSD_PORT=30111
export SPK_METRICS_STATSD_PREFIX=
export SPK_METRICS_STATSD_FORMAT=statsd-exporter-librato
dev env -- cargo build --release --features "sentry, migration-to-components, statsd"

# 2. create a new spfs layer
spfs run - -- sh -c "mkdir -p /spfs/opt/spk.dist \
  && cp target/release/spk /spfs/opt/spk.dist/ \
  && spfs commit platform --tag spk/spk-launcher/\"$tag_name\""
